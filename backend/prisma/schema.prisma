generator client {
  provider = "prisma-client-js"
  // output   = "../src/generated/prisma"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model article_likes {
  user_id    BigInt   @db.UnsignedBigInt
  article_id BigInt   @db.UnsignedBigInt
  created_at DateTime @default(now()) @db.Timestamp(0)
  article   articles @relation(fields: [article_id], references: [id], onDelete: Cascade, map: "fk_likes_article")
  user      users    @relation(fields: [user_id], references: [id], onDelete: Cascade, map: "fk_likes_user")

  @@id([user_id, article_id])
  @@index([article_id], map: "fk_likes_article")
}

model articles {
  id            BigInt          @id @default(autoincrement()) @db.UnsignedBigInt
  user_id       BigInt          @db.UnsignedBigInt
  content       String          @db.Text
  location      String?         @db.VarChar(50)
  status        Int             @default(0) @db.UnsignedTinyInt
  like_count    Int             @default(0) @db.UnsignedInt
  comment_count Int             @default(0) @db.UnsignedInt
  published_at  DateTime?       @db.Timestamp(0)
  created_at    DateTime        @default(now()) @db.Timestamp(0)
  updated_at    DateTime        @default(now()) @updatedAt @db.Timestamp(0)
  deleted_at    DateTime?       @db.Timestamp(0)
  // 关系字段（一篇文章属于一个用户），指向users的关系
  user         users           @relation(fields: [user_id], references: [id], onDelete: Cascade, map: "fk_articles_user")
  // 反向关系字段（一篇文章可以有多个评论、喜欢）
  comments      comments[]
  article_likes article_likes[]
  @@index([status, published_at], map: "idx_status_published")
  @@index([user_id], map: "idx_user_id")
}

model comments {
  id             BigInt     @id @default(autoincrement()) @db.UnsignedBigInt
  article_id     BigInt     @db.UnsignedBigInt
  user_id        BigInt     @db.UnsignedBigInt
  parent_id      BigInt?    @db.UnsignedBigInt
  content        String     @db.Text
  created_at     DateTime   @default(now()) @db.Timestamp(0)
  updated_at     DateTime   @default(now()) @updatedAt @db.Timestamp(0)
  deleted_at     DateTime?  @db.Timestamp(0)
  // 关系字段
  article       articles   @relation(fields: [article_id], references: [id], onDelete: Cascade, map: "fk_comments_article")
  parent        comments?  @relation("commentsTocomments", fields: [parent_id], references: [id], onDelete: Cascade, map: "fk_comments_parent")
  replies         comments[] @relation("commentsTocomments")
  user          users      @relation(fields: [user_id], references: [id], onDelete: Cascade, map: "fk_comments_user")

  @@index([article_id], map: "idx_article_id")
  @@index([parent_id], map: "idx_parent_id")
  @@index([user_id], map: "idx_user_id")
}

model logs {
  id          BigInt   @id @default(autoincrement()) @db.UnsignedBigInt
  user_id     BigInt?  @db.UnsignedBigInt
  action      String   @db.VarChar(50)
  target_type String?  @db.VarChar(50)
  target_id   BigInt?  @db.UnsignedBigInt
  details     Json?
  ip_address  String?  @db.VarChar(45)
  user_agent  String?  @db.Text
  status      String   @default("SUCCESS") @db.VarChar(20)
  created_at  DateTime @default(now()) @db.Timestamp(0)
  user        users?   @relation(fields: [user_id], references: [id], onDelete: NoAction, map: "fk_logs_user")

  @@index([action], map: "idx_action")
  @@index([created_at], map: "idx_created_at")
  @@index([target_type, target_id], map: "idx_target")
  @@index([user_id], map: "idx_user_id")
}

// 用户表
model users {
  id                BigInt          @id @default(autoincrement()) @db.UnsignedBigInt
  username          String          @unique(map: "uk_username") @db.VarChar(30)
  password          String          @db.VarChar(255)
  nickname          String?         @db.VarChar(50)
  brief             String?         @db.VarChar(255)
  role              Int             @default(0) @db.UnsignedTinyInt
  status            Int             @default(0) @db.UnsignedTinyInt
  email             String?         @unique(map: "uk_email") @db.VarChar(120)
  header_background String?         @db.VarChar(255)
  avatar            String?         @db.VarChar(255)
  created_at        DateTime        @default(now()) @db.Timestamp(0)
  updated_at        DateTime        @default(now()) @updatedAt @db.Timestamp(0)
  deleted_at        DateTime?       @db.Timestamp(0)
  // 反向关系
  article_likes     article_likes[]
  articles          articles[]
  comments          comments[]
  logs              logs[]

  @@index([status], map: "idx_status")
}
